<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;网上相关yaml文件：&quot;&gt;&lt;a href=&quot;#网上相关yaml文件：&quot; class=&quot;headerlink&quot; title=&quot;网上相关yaml文件：&quot;&gt;&lt;/a&gt;网上相关yaml文件：&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;yaml 文件相关"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>aliyun k8s虚拟节点调度 | linkpwd|</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">主页</a><a class="sidebar-nav-item" href="/archives">归档</a></nav><div class="container post-meta"><div class="post-time">2022-01-26</div></div></div><div class="container post-header"><h1>aliyun k8s虚拟节点调度</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">目录</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E4%B8%8A%E7%9B%B8%E5%85%B3yaml%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">网上相关yaml文件：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%B7%B1%E5%86%99%E7%9A%84%E4%B8%80%E4%B8%AAyaml%EF%BC%8C%E9%80%9A%E8%BF%87%E6%90%9C%E7%B4%A2%E5%92%8C%E7%BB%93%E5%90%88%E4%B8%8A%E9%9D%A2%E7%9A%84"><span class="toc-number">2.</span> <span class="toc-text">自己写的一个yaml，通过搜索和结合上面的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E4%B8%8A%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E6%B3%95%EF%BC%9A"><span class="toc-number">3.</span> <span class="toc-text">官方上的两种方法：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E7%9A%84%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98"><span class="toc-number">4.</span> <span class="toc-text">调度的的一些问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol></details></div><div class="container post-content"><h3 id="网上相关yaml文件："><a href="#网上相关yaml文件：" class="headerlink" title="网上相关yaml文件："></a>网上相关yaml文件：</h3><ol>
<li><p>yaml 文件相关</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat nginx.yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">name: nginx</span><br><span class="line">spec:</span><br><span class="line">containers:</span><br><span class="line">- image: nginx</span><br><span class="line">    imagePullPolicy: Always</span><br><span class="line">    name: nginx</span><br><span class="line">nodeSelector:</span><br><span class="line">    kubernetes.io/role: agent</span><br><span class="line">    beta.kubernetes.io/os: linux</span><br><span class="line">    <span class="built_in">type</span>: virtual-kubelet</span><br><span class="line">tolerations:</span><br><span class="line">- key: virtual-kubelet.io/provider</span><br><span class="line">    operator: Exists</span><br></pre></td></tr></table></figure></li>
<li><p>通过节点信息，查看节点的标签及污点：</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">标签</span> <span class="string">:</span> <span class="attr">alpha.service-controller.kubernetes.io/exclude-balancer: true beta.kubernetes.io/arch: amd64 beta.kubernetes.io/os: linux failure-domain.beta.kubernetes.io/region: cn-hangzhou failure-domain.beta.kubernetes.io/zone: cn-hangzhou-j kubernetes.io/arch: amd64 kubernetes.io/hostname: virtual-kubelet-cn-hangzhou-j kubernetes.io/os: linux kubernetes.io/role: agent service.beta.kubernetes.io/exclude-node: true type:</span> <span class="string">virtual-kubelet</span></span><br><span class="line"></span><br><span class="line"><span class="string">污点</span> <span class="string">（Taints）</span> <span class="string">:</span> <span class="attr">virtual-kubelet.io/provider: alibabacloud Effect:</span> <span class="string">NoSchedule</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="自己写的一个yaml，通过搜索和结合上面的"><a href="#自己写的一个yaml，通过搜索和结合上面的" class="headerlink" title="自己写的一个yaml，通过搜索和结合上面的"></a>自己写的一个yaml，通过搜索和结合上面的</h3><p>调度到virtual-kubelet :<br>  labels:<br>    alibabacloud.com/eci: ‘true’<br>      nodeSelector:<br>        beta.kubernetes.io/os: linux<br>        kubernetes.io/role: agent<br>        type: virtual-kubelet<br>      tolerations:<br>        - key: virtual-kubelet.io/provider<br>          operator: Exists</p>
<h3 id="官方上的两种方法："><a href="#官方上的两种方法：" class="headerlink" title="官方上的两种方法："></a>官方上的两种方法：</h3><ol>
<li><p>pod直接启动时设置参数(当然前提vk 要配置好启动好)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl run nginx --image nginx -l alibabacloud.com/eci=<span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>配置命名空间标签<br>给Pod所在的命名空间添加标签alibabacloud.com/eci=true，Pod将以ECI方式运行，其节点是虚拟节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label namespace vk alibabacloud.com/eci=<span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>指定annotation规格。<br>在节点亲和性nodeAffinity中指定virtual-kubelet。<br>设置节点容忍标签为virtual-kubelet.io/provider。</p>
<h3 id="调度的的一些问题"><a href="#调度的的一些问题" class="headerlink" title="调度的的一些问题"></a>调度的的一些问题</h3><ol>
<li>virtual-kubelet一般只会创建一个节点，只有一个交换机，也就是说调度只能调度到相应的这个交换机网段，如果使用eni模式，IP网段分配不够（如256个）扩展能力就受限，需要处理</li>
<li>添加所属区域交换机及网段</li>
<li>修改kube-system命名空间的 eni-config添加相应交换机ID, eci-profile 配置文件，vSwitchIds添加上交换机ID</li>
</ol>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/744139">虚拟节点创建1万Pod</a><br><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/122921.html">基于ECI运行Job任务</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhaowei121/article/details/89399801">快速部署虚拟节点提升集群弹性能</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_34293141/article/details/89618477">快速部署虚拟节点virtual-nodes</a><br><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/118970.html?spm=a2c4g.11186623.0.0.185c7472WcwE5E">通过部署ACK虚拟节点组件创建ECI Pod</a></p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>