<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=" id=&quot;配置文件，使支持websocket协议&quot;&gt;&lt;a href=&quot;#配置文件，使支持websocket协议&quot; class=&quot;headerlink&quot; title=&quot;配置文件，使支持websocket协议&quot;&gt;&lt;/a&gt;配置文件，使支持websocket协议&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://www.nginx.com/blog/websocket-nginx/&quot;&gt;websocket-nginx&lt;/a&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>WebSocket服务部署 | linkpwd|</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 5.4.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">主页</a><a class="sidebar-nav-item" href="/archives">归档</a></nav><div class="container post-meta"><div class="post-time">2021-12-06</div></div></div><div class="container post-header"><h1>WebSocket服务部署</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">目录</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%8C%E4%BD%BF%E6%94%AF%E6%8C%81websocket%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.</span> <span class="toc-text">配置文件，使支持websocket协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8Fproxy-read-timeout"><span class="toc-number">2.</span> <span class="toc-text">需要注意proxy_read_timeout</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%B8%82%E5%9C%BA%E4%BD%BF%E7%94%A8WebSocket-Test-Client%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">3.</span> <span class="toc-text">应用市场使用WebSocket Test Client进行测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#k8s-ingress%E4%B8%AD%E8%AE%BE%E7%BD%AEwebsocket"><span class="toc-number">4.</span> <span class="toc-text">k8s ingress中设置websocket</span></a></li></ol></details></div><div class="container post-content"><h3 id="配置文件，使支持websocket协议"><a href="#配置文件，使支持websocket协议" class="headerlink" title="配置文件，使支持websocket协议"></a>配置文件，使支持websocket协议</h3><p><a target="_blank" rel="noopener" href="https://www.nginx.com/blog/websocket-nginx/">websocket-nginx</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server</span> &#123;</span><br><span class="line">    <span class="string">listen</span>       <span class="number">80</span><span class="string">;</span></span><br><span class="line">    <span class="string">server_name</span>  <span class="string">localhost;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">        <span class="string">root</span>   <span class="string">/usr/share/nginx/html;</span></span><br><span class="line">        <span class="string">index</span>  <span class="string">index.html</span> <span class="string">index.htm;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">location</span> <span class="string">=</span> <span class="string">/50x.html</span> &#123;</span><br><span class="line">        <span class="string">root</span>   <span class="string">/usr/share/nginx/html;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">location</span> <span class="string">/ejy-push-service</span> &#123;</span><br><span class="line">        <span class="string">proxy_set_header</span> <span class="string">Host</span> <span class="string">$host;</span></span><br><span class="line">        <span class="string">proxy_set_header</span> <span class="string">X-Forwarded-For</span> <span class="string">$proxy_add_x_forwarded_for;</span></span><br><span class="line">        <span class="string">proxy_set_header</span> <span class="string">X-Forwarded-Proto</span> <span class="string">$scheme;</span></span><br><span class="line">        <span class="string">proxy_http_version</span>  <span class="number">1.1</span><span class="string">;</span></span><br><span class="line">        <span class="string">proxy_set_header</span> <span class="string">Upgrade</span> <span class="string">$http_upgrade;</span></span><br><span class="line">        <span class="string">proxy_set_header</span> <span class="string">Connection</span> <span class="string">&quot;upgrade&quot;</span><span class="string">;</span></span><br><span class="line">        <span class="string">proxy_read_timeout</span>  <span class="number">600</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">proxy_pass</span> <span class="string">http://localhost:19877/;</span></span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="需要注意proxy-read-timeout"><a href="#需要注意proxy-read-timeout" class="headerlink" title="需要注意proxy_read_timeout"></a>需要注意proxy_read_timeout</h3><p>websocket也是一种长链接，默认的proxy_read_timeout 为60s</p>
<h3 id="应用市场使用WebSocket-Test-Client进行测试"><a href="#应用市场使用WebSocket-Test-Client进行测试" class="headerlink" title="应用市场使用WebSocket Test Client进行测试"></a>应用市场使用WebSocket Test Client进行测试</h3><p>ws://<a target="_blank" rel="noopener" href="http://www.test.com/ws">www.test.com/ws</a><br>wss://<a target="_blank" rel="noopener" href="http://www.test.com/wss">www.test.com/wss</a></p>
<p>URL :  ws://<a target="_blank" rel="noopener" href="http://www.test.com/ws">www.test.com/ws</a><br>REQUEST: {“type”: “ping” }<br>Message Log:<br>    {“type”: “ping” }<br>    {“type”:”ping”,”message”:”pong…”}</p>
<h3 id="k8s-ingress中设置websocket"><a href="#k8s-ingress中设置websocket" class="headerlink" title="k8s ingress中设置websocket"></a>k8s ingress中设置websocket</h3><pre><code class="yaml">apiVersion: extensions/v1beta1     
kind: Ingress    
metadata:           
  name: ingress名称
  namespace: ingress所属命名空间
  annotations:           
    #ingress使用那种软件 
    kubernetes.io/ingress.class: nginx
    #配置websocket 需要的配置   
    nginx.ingress.kubernetes.io/configuration-snippet: |
       proxy_set_header Upgrade &quot;websocket&quot;;
       proxy_set_header Connection &quot;Upgrade&quot;;
spec:      
  rules: 
  - host: 识别的域名
    http:
      paths: 
        #代理websocket服务
      - path: /websocket地址
        backend:
          serviceName: websocket服务名称
          servicePort: websocket服务端口
</code></pre>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>